---
- name: Setup Terraform on target hosts
  hosts: target_hosts
  become: true

  vars_files:
    - configs/configs.yml

  tasks:

    - name: Check if Terraform is already installed
      command: terraform version
      register: terraform_check
      failed_when: false
      changed_when: false

    - name: Display current Terraform version if installed
      ansible.builtin.debug:
        msg: "Terraform is already installed: {{ terraform_check.stdout }}"
      when: terraform_check.rc == 0

    - name: Update package cache (Debian/Ubuntu)
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Update package cache (RedHat/CentOS)
      ansible.builtin.yum:
        update_cache: yes
      when: ansible_os_family == "RedHat"

    - name: Install required packages (Debian/Ubuntu)
      ansible.builtin.apt:
        name:
          - unzip
          - curl
          - wget
        state: present
      when: ansible_os_family == "Debian"

    - name: Install required packages (RedHat/CentOS)
      ansible.builtin.yum:
        name:
          - unzip
          - curl
          - wget
        state: present
      when: ansible_os_family == "RedHat"

    - name: Create temporary directory for Terraform download
      ansible.builtin.tempfile:
        state: directory
        suffix: terraform
      register: terraform_temp_dir

    - name: Download Terraform
      ansible.builtin.get_url:
        url: "{{ terraform.download_url }}"
        dest: "{{ terraform_temp_dir.path }}/terraform.zip"
        mode: '0644'
      when: terraform_check.rc != 0

    - name: Extract Terraform binary
      ansible.builtin.unarchive:
        src: "{{ terraform_temp_dir.path }}/terraform.zip"
        dest: "{{ terraform_temp_dir.path }}"
        remote_src: yes
      when: terraform_check.rc != 0

    - name: Install Terraform binary
      ansible.builtin.copy:
        src: "{{ terraform_temp_dir.path }}/terraform"
        dest: "{{ terraform.install_path }}"
        mode: '0755'
        remote_src: yes
      when: terraform_check.rc != 0

    - name: Clean up temporary directory
      ansible.builtin.file:
        path: "{{ terraform_temp_dir.path }}"
        state: absent
      when: terraform_check.rc != 0

    - name: Verify Terraform installation
      ansible.builtin.command: terraform version
      register: terraform_version_output
      changed_when: false

    - name: Display Terraform version
      ansible.builtin.debug:
        msg: "{{ terraform_version_output.stdout }}"

    - name: Confirm Terraform setup complete
      ansible.builtin.debug:
        msg: "Terraform {{ terraform.version }} has been successfully installed at {{ terraform.install_path }}"

